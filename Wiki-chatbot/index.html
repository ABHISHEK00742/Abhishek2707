<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WikiNews Chatbot</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #09090f;
    --surface: #111118;
    --card: #17171f;
    --border: #252535;
    --accent: #5bf0a5;
    --accent2: #5b8bf0;
    --accent3: #f0a55b;
    --warn: #f05b7a;
    --text: #e4e4f0;
    --muted: #5a5a78;
    --user-bubble: #1a2040;
    --bot-bubble: #121820;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Animated background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 36px 36px;
    opacity: 0.2;
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.5rem;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 10;
  }

  .logo {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--accent2), var(--accent));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
  }

  .header-text h1 {
    font-size: 1rem;
    font-weight: 800;
    line-height: 1;
  }

  .header-text p {
    font-size: 0.65rem;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    margin-top: 0.15rem;
  }

  .status {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent);
  }

  .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--accent);
    animation: pulse 2s infinite;
  }

  .btn-reset {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.35rem 0.75rem;
    border-radius: 4px;
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    margin-left: 1rem;
  }

  .btn-reset:hover { border-color: var(--warn); color: var(--warn); }

  /* ‚îÄ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ‚îÄ */
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    position: relative;
    z-index: 1;
  }

  #chat::-webkit-scrollbar { width: 4px; }
  #chat::-webkit-scrollbar-track { background: transparent; }
  #chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg-row {
    display: flex;
    gap: 0.75rem;
    animation: slideIn 0.3s ease both;
  }

  .msg-row.user { flex-direction: row-reverse; }

  .avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
  }

  .avatar-bot { background: var(--card); border: 1px solid var(--border); }
  .avatar-user { background: var(--user-bubble); border: 1px solid var(--accent2); }

  .bubble {
    max-width: 75%;
    padding: 0.9rem 1.1rem;
    border-radius: 12px;
    font-size: 0.875rem;
    line-height: 1.65;
  }

  .bubble-user {
    background: var(--user-bubble);
    border: 1px solid #2a3060;
    border-radius: 12px 2px 12px 12px;
    color: var(--text);
  }

  .bubble-bot {
    background: var(--bot-bubble);
    border: 1px solid var(--border);
    border-radius: 2px 12px 12px 12px;
    color: var(--text);
  }

  /* Result card inside bot bubble */
  .result-card {
    margin-top: 0.75rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .result-header {
    padding: 0.6rem 0.9rem;
    background: #1a1a28;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .result-header a {
    color: var(--accent2);
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .result-header a:hover { text-decoration: underline; }

  .keywords {
    padding: 0.6rem 0.9rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    border-top: 1px solid var(--border);
  }

  .kw-tag {
    background: #1a102a;
    color: #c084fc;
    border: 1px solid #3a1a5a;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    font-size: 0.62rem;
    font-family: 'Space Mono', monospace;
  }

  .alt-results {
    padding: 0.6rem 0.9rem;
    border-top: 1px solid var(--border);
  }

  .alt-results p {
    font-size: 0.65rem;
    color: var(--muted);
    font-family: 'Space Mono', monospace;
    margin-bottom: 0.4rem;
  }

  .alt-btn {
    display: inline-block;
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    cursor: pointer;
    margin: 0.15rem;
    transition: border-color 0.2s;
  }
  .alt-btn:hover { border-color: var(--accent); color: var(--accent); }

  .source-section {
    padding: 0.6rem 0.9rem;
    border-top: 1px solid var(--border);
  }
  .source-section p { font-size: 0.65rem; color: var(--muted); margin-bottom: 0.4rem; font-family: 'Space Mono', monospace; }
  .source-item {
    display: block;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.4rem 0.6rem;
    margin: 0.35rem 0;
    font-size: 0.75rem;
    color: var(--text);
    text-decoration: none;
    transition: border-color 0.2s;
  }
  .source-item:hover { border-color: var(--accent2); }
  .source-item .title { font-weight: 600; color: var(--accent2); }
  .source-item .snippet { color: var(--muted); font-size: 0.7rem; margin-top: 0.2rem; }
  .reddit-badge { color: #ff4500; }
  .web-badge { color: var(--accent3); }

  /* Suggestions */
  .suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .suggest-btn {
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
    font-family: 'Syne', sans-serif;
  }

  .suggest-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Typing indicator */
  .typing {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 0.75rem 1rem;
  }
  .typing span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--muted);
    animation: bounce 1.2s infinite;
  }
  .typing span:nth-child(2) { animation-delay: 0.15s; }
  .typing span:nth-child(3) { animation-delay: 0.3s; }

  /* ‚îÄ‚îÄ‚îÄ INPUT AREA ‚îÄ‚îÄ‚îÄ */
  footer {
    padding: 1rem 1.5rem;
    background: var(--surface);
    border-top: 1px solid var(--border);
    position: relative;
    z-index: 10;
  }

  .input-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.6rem 0.75rem;
    transition: border-color 0.2s;
  }

  .input-row:focus-within { border-color: var(--accent2); }

  #inputBox {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-size: 0.9rem;
    font-family: 'Syne', sans-serif;
    resize: none;
    max-height: 100px;
    line-height: 1.5;
  }

  #inputBox::placeholder { color: var(--muted); }

  #sendBtn {
    width: 34px;
    height: 34px;
    border-radius: 8px;
    background: var(--accent2);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: background 0.2s, transform 0.1s;
    flex-shrink: 0;
  }

  #sendBtn:hover { background: #7aa8ff; transform: scale(1.05); }
  #sendBtn:active { transform: scale(0.95); }
  #sendBtn:disabled { background: var(--border); cursor: not-allowed; transform: none; }

  .footer-hint {
    text-align: center;
    font-size: 0.6rem;
    color: var(--muted);
    margin-top: 0.5rem;
    font-family: 'Space Mono', monospace;
  }

  /* ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ */
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-6px); }
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">üì∞</div>
  <div class="header-text">
    <h1>WikiNews Chatbot</h1>
    <p>Wikipedia + Reddit + Web Search</p>
  </div>
  <div class="status">
    <div class="status-dot"></div>
    Online
  </div>
  <button class="btn-reset" onclick="resetChat()">‚Ü∫ Reset</button>
</header>

<!-- CHAT -->
<div id="chat">
  <!-- Welcome message -->
  <div class="msg-row bot">
    <div class="avatar avatar-bot">ü§ñ</div>
    <div class="bubble bubble-bot">
      Hey! I'm <strong>WikiBot</strong> ‚Äî I compare Wikipedia, Reddit, and web search to give you the best answer. Ask about any topic! üìñ
      <div class="suggestions">
        <button class="suggest-btn" onclick="quickSend('Tell me about Artificial Intelligence')">üß† Artificial Intelligence</button>
        <button class="suggest-btn" onclick="quickSend('What is climate change?')">üåç Climate Change</button>
        <button class="suggest-btn" onclick="quickSend('Latest on space exploration')">üöÄ Space Exploration</button>
        <button class="suggest-btn" onclick="quickSend('Quantum computing')">‚öõÔ∏è Quantum Computing</button>
      </div>
    </div>
  </div>
</div>

<!-- INPUT -->
<footer>
  <div class="input-row">
    <textarea id="inputBox" rows="1" placeholder="Ask about any topic‚Ä¶ (Enter to send)"></textarea>
    <button id="sendBtn" onclick="sendMessage()" title="Send">‚û§</button>
  </div>
  <div class="footer-hint">Enter to send ¬∑ Shift+Enter for new line ¬∑ Try: "more" to expand ¬∑ "keywords" for tags</div>
</footer>

<script>
  const chat = document.getElementById('chat');
  const inputBox = document.getElementById('inputBox');
  const sendBtn = document.getElementById('sendBtn');

  // Event delegation for alt-btn (related topic buttons) ‚Äî handles data-title attribute
  // so titles with apostrophes / special chars work correctly
  document.getElementById('chat').addEventListener('click', e => {
    const btn = e.target.closest('.alt-btn');
    if (btn && btn.dataset.title) {
      quickSend(btn.dataset.title);
    }
  });

  // Auto-resize textarea
  inputBox.addEventListener('input', () => {
    inputBox.style.height = 'auto';
    inputBox.style.height = Math.min(inputBox.scrollHeight, 100) + 'px';
  });

  // Enter to send
  inputBox.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  function scrollToBottom() {
    chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
  }

  function addMessage(role, html) {
    const row = document.createElement('div');
    row.className = `msg-row ${role}`;
    const icon = role === 'user' ? 'üßë' : 'ü§ñ';
    const bubbleClass = role === 'user' ? 'bubble-user' : 'bubble-bot';
    const avatarClass = role === 'user' ? 'avatar-user' : 'avatar-bot';
    row.innerHTML = `
      <div class="avatar ${avatarClass}">${icon}</div>
      <div class="bubble ${bubbleClass}">${html}</div>
    `;
    chat.appendChild(row);
    scrollToBottom();
    return row;
  }

  function showTyping() {
    const row = document.createElement('div');
    row.className = 'msg-row bot';
    row.id = 'typing-row';
    row.innerHTML = `
      <div class="avatar avatar-bot">ü§ñ</div>
      <div class="bubble bubble-bot">
        <div class="typing"><span></span><span></span><span></span></div>
      </div>
    `;
    chat.appendChild(row);
    scrollToBottom();
  }

  function hideTyping() {
    const t = document.getElementById('typing-row');
    if (t) t.remove();
  }

  function buildBotHtml(data) {
    const safeText = escHtml((data && data.text) || '');
    let html = `<p>${safeText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>`;

    if (data && data.title) {
      html += `<div class="result-card">
        <div class="result-header">
          <span>üìñ</span>`;
      if (data.url) {
        html += `<a href="${escHtml(data.url)}" target="_blank" rel="noopener">${escHtml(data.title)} ‚Üó</a>`;
      } else {
        html += `<span style="color:var(--muted);font-size:0.9rem">${escHtml(data.title)}</span>`;
      }
      html += `</div>`;

      if (data.keywords && data.keywords.length) {
        html += `<div class="keywords">`;
        data.keywords.forEach(k => {
          html += `<span class="kw-tag">#${escHtml(k)}</span>`;
        });
        html += `</div>`;
      }

      if (data.results && data.results.length) {
        html += `<div class="alt-results"><p>// related topics</p>`;
        data.results.slice(0, 3).forEach(r => {
          html += `<button class="alt-btn" data-title="${escAttr(r.title)}">${escHtml(r.title)}</button>`;
        });
        html += `</div>`;
      }

      if (data.reddit && data.reddit.length) {
        html += `<div class="source-section"><p><span class="reddit-badge">‚óâ</span> Reddit</p>`;
        data.reddit.slice(0, 3).forEach(r => {
          const url = escHtml(r.url || '#');
          html += `<a href="${url}" target="_blank" rel="noopener" class="source-item"><span class="title">r/${escHtml(r.subreddit || '')}</span>: ${escHtml((r.title || '').slice(0, 60))}${(r.title || '').length > 60 ? '‚Ä¶' : ''}<span class="snippet">${escHtml((r.snippet || '').slice(0, 80))}‚Ä¶</span></a>`;
        });
        html += `</div>`;
      }
      if (data.web && data.web.length) {
        html += `<div class="source-section"><p><span class="web-badge">‚óâ</span> Web</p>`;
        data.web.slice(0, 3).forEach(r => {
          const url = escHtml(r.url || '#');
          html += `<a href="${url}" target="_blank" rel="noopener" class="source-item"><span class="title">${escHtml((r.title || '').slice(0, 50))}${(r.title || '').length > 50 ? '‚Ä¶' : ''}</span><span class="snippet">${escHtml((r.snippet || '').slice(0, 90))}‚Ä¶</span></a>`;
        });
        html += `</div>`;
      }

      html += `</div>`;
    }

    return html;
  }

  async function sendMessage() {
    const text = inputBox.value.trim();
    if (!text) return;

    inputBox.value = '';
    inputBox.style.height = 'auto';
    sendBtn.disabled = true;

    addMessage('user', escHtml(text));
    showTyping();

    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text }),
      });

      const data = await res.json();
      hideTyping();

      if (!res.ok) {
        // server-side error (e.g. empty message)
        const errMsg = (data && data.error) ? data.error : 'Server error';
        addMessage('bot', escHtml(errMsg));
        sendBtn.disabled = false;
        inputBox.focus();
        return;
      }

      addMessage('bot', buildBotHtml(data));

      if (data.type === 'bye') {
        inputBox.disabled = true;
        sendBtn.disabled = true;
      }
    } catch (err) {
      hideTyping();
      addMessage('bot', '‚ö†Ô∏è Connection error. Make sure the Flask server is running.');
    }

    sendBtn.disabled = false;
    inputBox.focus();
  }

  function quickSend(text) {
    inputBox.value = text;
    sendMessage();
  }

  async function resetChat() {
    await fetch('/reset', { method: 'POST' });
    chat.innerHTML = '';
    inputBox.disabled = false;
    sendBtn.disabled = false;
    addMessage('bot', "Fresh start! üîÑ What would you like to explore?");
  }

  function escHtml(str) {
    if (!str) return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function escAttr(str) {
    if (!str) return '';
    // Encode all special characters as HTML entities ‚Äî prevents apostrophes and quotes
    // in Wikipedia titles (e.g. "Don't Look Up") from breaking onclick handlers
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }
</script>
</body>
</html>
